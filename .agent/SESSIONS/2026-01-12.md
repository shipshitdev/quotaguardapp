# Session: 2026-01-12

## Session 4: Widget Shared Data Fix (~30 min)

**Status:** Complete

### System Flow Diagram

1. App refreshes usage in `UsageDataManager.refreshAll()`
   ↓
2. App writes metrics to App Group JSON (`cached_usage_metrics.json`)
   ↓
3. Widget reads the same JSON via App Group container
   ↓
4. Widget timeline renders usage (including Claude Code)

### What was done:

- Added App Group entitlements to app and widget targets
- Created widget entitlements file and wired it in Xcode project settings
- Updated widget shared store to read the same JSON file as the app
- Added Claude Code to widget service types for decoding/display

### Files changed:

- `QuotaGuard/QuotaGuard.entitlements` - added App Group entitlement
- `QuotaGuard/App/QuotaGuard.entitlements` - added App Group entitlement
- `QuotaGuardWidget/QuotaGuardWidget.entitlements` - new widget entitlements file
- `QuotaGuard.xcodeproj/project.pbxproj` - widget CODE_SIGN_ENTITLEMENTS set
- `QuotaGuardWidget/UsageWidget.swift` - shared store + Claude Code service

### Decisions:

- **Decision:** Reuse App Group JSON file for widget data
  - **Context:** App already writes JSON to App Group container
  - **Rationale:** Minimal change and consistent data source

### Mistakes and fixes:

- None

### Next steps:

- [ ] Confirm App Group capability is enabled in Xcode for both targets
- [ ] Rebuild app + widget to validate timeline data updates

---

## Session 3: Usage Collection Review (~20 min)

**Status:** Complete

### What was done:

- Reviewed usage collection for Claude Code, Codex CLI, and Cursor
- Identified display/auth gating issues for Codex and UI mismatch notes
- Drafted recommendations for Codex display parity and Cursor reset/limit fixes

### Files changed:

- None (review only)

### Decisions:

- **Decision:** Provide review findings without code changes
  - **Context:** User requested a review and guidance
  - **Rationale:** Await confirmation before modifying behavior

### Mistakes and fixes:

- None

### Next steps:

- [ ] Add Codex service type/UI row or allow Codex metrics to display without OpenAI admin key
- [ ] Fix Cursor reset time to end-of-month and adjust request limit calculation
- [ ] Update Cursor UI copy to reflect SQLite auth and align rescan behavior in menu

---

## Session 1: QuotaGuard Sandbox & UI Fixes (~45 min)

**Status:** In Progress (pending entitlements verification)

### What was done:

1. **Reordered service cards** in MenuBarView.swift
   - New order: Claude Code, Claude API, OpenAI, Cursor
   - Changed from showing all 4 to auto-detect Claude service (Claude Code if logged in, else Claude API)

2. **Fixed Claude Code expand/collapse**
   - Chevron now properly toggles usage metrics visibility
   - Changed icon from gearshape to chevron.down when collapsed

3. **Created entitlements file** (`QuotaGuard/QuotaGuard.entitlements`)
   - `com.apple.security.network.client` - for API calls
   - `com.apple.security.files.user-selected.read-only`
   - `com.apple.security.temporary-exception.files.home-relative-path.read-only` - for Cursor database access

4. **Fixed ClaudeCodeLocalService API endpoint**
   - Removed multiple endpoint trial-and-error
   - Now uses single working endpoint: `https://api.anthropic.com/api/oauth/usage`
   - Removed verbose logging

5. **Fixed duplicate refresh calls**
   - Removed initial `refreshAll()` in `applicationDidFinishLaunching`
   - `monitorUsage()` already handles initial refresh

6. **Fixed Cursor database path for sandbox**
   - Added `getRealHomeDirectory()` function using `getpwuid(getuid())`
   - Sandbox remaps home directory to container; now uses real home path
   - Database now found at correct path: `/Users/decod3rs/Library/Application Support/Cursor/User/globalStorage/state.vscdb`

### Files changed:

- `QuotaGuard/Views/MenuBarView.swift` - Reordered services, fixed expand/collapse, auto-detect Claude service
- `QuotaGuard/Services/ClaudeCodeLocalService.swift` - Single endpoint, removed verbose logging, simplified fetch
- `QuotaGuard/Services/CursorLocalService.swift` - Added `getRealHomeDirectory()`, better error logging
- `QuotaGuard/Services/UsageDataManager.swift` - Removed verbose logging
- `QuotaGuard/App/QuotaGuardApp.swift` - Removed duplicate refresh call
- `QuotaGuard/QuotaGuard.entitlements` - NEW: Created with network + file access entitlements

### Decisions:

- **Auto-detect Claude service**: Show Claude Code if OAuth available, else show Claude API if key configured, else show Claude Code with login prompt
- **Temporary exception entitlement**: Required for sandbox to read Cursor database at `~/Library/Application Support/Cursor/`

### Pending/Next steps:

- [ ] Verify entitlements file is linked in Xcode Build Settings (`CODE_SIGN_ENTITLEMENTS = QuotaGuard/QuotaGuard.entitlements`)
- [ ] Rebuild and test Cursor database access with proper entitlements
- [ ] Test full functionality: Claude Code usage, Cursor usage display

### Known issues:

- Cursor database found but "not readable" - sandbox still blocking despite entitlements file created
- Need to set `Code Signing Entitlements` in Build Settings to `QuotaGuard/QuotaGuard.entitlements`

---

## Session 2: Code Simplification & Optimization (~20 min)

**Status:** Complete

### Goal

Analyze codebase for optimization opportunities and remove duplicate code.

### What was done:

1. **Deleted dead code** - Removed unused `CursorService.swift` (32 lines)
   - File was never imported or referenced
   - Only contained Twitter intent stub and error-throwing fetch method
   - `CursorLocalService` is the actual implementation used

2. **Added `UsageStatus.color` extension** - Eliminated 9 duplicate functions
   - Added `color` property to `UsageStatus` enum in `UsageLimit.swift`
   - Added same property to widget's local `UsageStatus` in `UsageWidget.swift`
   - Removed 5 `colorForStatus()` functions from `MenuBarView.swift`
   - Removed 4 `colorForStatus()` functions from `UsageWidget.swift`

3. **Fixed duplicate refresh loop** in `QuotaGuardApp.swift`
   - **Before:** `monitorUsage()` called `refreshAll()` every 5 min + `UsageDataManager` timer every 15 min
   - **After:** Single initial refresh on launch, `UsageDataManager` handles 15-min auto-refresh
   - Notification check still runs every 5 min but doesn't trigger API calls

### Files changed:

- `QuotaGuard/Services/CursorService.swift` - DELETED (dead code)
- `QuotaGuard/Models/UsageLimit.swift` - Added `UsageStatus.color` property, added SwiftUI import
- `QuotaGuard/Views/MenuBarView.swift` - Removed 5 duplicate `colorForStatus()` functions, updated to use `.color`
- `QuotaGuardWidget/UsageWidget.swift` - Added `UsageStatus.color`, removed 4 duplicate functions
- `QuotaGuard/App/QuotaGuardApp.swift` - Removed redundant `refreshAll()` from monitoring loop

### Code impact:

| Metric | Before | After |
|--------|--------|-------|
| `colorForStatus()` functions | 9 | 0 |
| Duplicate refresh calls | 2 (5min + 15min) | 1 (15min) |
| Dead code files | 1 | 0 |
| Lines removed | ~86 | - |

### Decisions:

- **Skipped URLSession extraction** - Only 6 lines duplicated, abstraction overhead not worth it
- **Skipped ServiceRow consolidation** - Larger refactor requiring careful planning, deferred to future session

### Not completed (future work):

- [ ] Consolidate 3 ServiceRow views (ServiceRowView, CursorServiceRow, ClaudeCodeServiceRow) - share 80% code
- [ ] Share models between main app and widget target (currently duplicated)
- [ ] Extract magic number thresholds (80%, 90%, 100%) to constants

---

## Session 3: README Screenshots (~20 min)

**Status:** Complete

### What was done:

1. **Built a SwiftUI snapshot renderer** to generate static screenshots for README use.
2. **Generated toolbar and widget images** with realistic sample usage data.
3. **Improved rendering fidelity** by replacing SwiftUI progress bars with a custom progress view to avoid missing render artifacts.

### Files changed:

- `scripts/render-readme-screenshots.swift` - New snapshot renderer script
- `docs/screenshots/menubar.png` - Menu bar UI screenshot (2x)
- `docs/screenshots/widget-medium.png` - Medium widget UI screenshot (2x)

### Notes:

- Renderer is run via `swiftc -parse-as-library` to avoid `@main` conflicts in Swift script mode.
- Uses local `.build/tmp` and `.build/module-cache` paths to avoid sandboxed cache permissions.

### Next steps:

- [ ] Add the new screenshots to `README.md` if desired

---

## Session 4: macOS-accurate Screenshot Capture (~30 min)

**Status:** In Progress

### What was done:

1. **Reworked the screenshot renderer** to use real macOS materials and capture the window via `screencapture` for accurate popover/widget visuals.
2. **Added a gradient backdrop window** so the blur effect has a consistent background.
3. **Switched to window-server capture** to avoid `NSVisualEffectView` rendering black in bitmap snapshots.

### Files changed:

- `scripts/render-readme-screenshots.swift` - Capture flow now uses `screencapture` with on-screen windows

### Notes:

- The capture command is blocked in the Codex sandbox; run locally in Terminal to generate final PNGs.
- macOS may prompt for Screen Recording permission for Terminal or the compiled binary.

### Next steps:

- [ ] Run the renderer locally to regenerate `docs/screenshots/menubar.png` and `docs/screenshots/widget-medium.png`

---

## Session 5: Documentation Cleanup (~5 min)

**Status:** Complete

### What was done:

- Moved 6 documentation files from project root to `.agent/docs/`
- Enforced convention: only README.md, CLAUDE.md, AGENTS.md, CODEX.md at root

### Files changed:

- `CONTRIBUTING.md` → `.agent/docs/CONTRIBUTING.md`
- `IMPLEMENTATION_STATUS.md` → `.agent/docs/IMPLEMENTATION_STATUS.md`
- `PROJECT_STRUCTURE.md` → `.agent/docs/PROJECT_STRUCTURE.md`
- `SETUP.md` → `.agent/docs/SETUP.md`
- `TESTING.md` → `.agent/docs/TESTING.md`
- `XCODE_SETUP.md` → `.agent/docs/XCODE_SETUP.md`

### Decisions:

- **Keep at root:** README.md (standard), CLAUDE.md (auto-read by Claude Code), AGENTS.md, CODEX.md (AI tool entry points)
- **Move to .agent/docs/:** All other project documentation

### Next steps:

- None

---

## Session 6: Collapse Button Fix (~5 min)

**Status:** Complete

### What was done:

- Fixed Claude Code service card collapse button not responding to clicks
- Root cause: `.buttonStyle(.plain)` with small icon created tiny tap target on macOS
- Applied same fix to all three service row types for consistency

### Files changed:

- `QuotaGuard/Views/MenuBarView.swift`
  - Line 120-121: ServiceRowView chevron - added `.frame(width: 24, height: 24).contentShape(Rectangle())`
  - Line 338-339: CursorServiceRow chevron - same fix
  - Line 462-463: ClaudeCodeServiceRow chevron - same fix

### Decisions:

- **24x24 tap target:** Minimum reasonable size for macOS button hit area
- **contentShape(Rectangle()):** Ensures entire frame is tappable, not just the icon pixels

### Issue encountered:

- User reported Xcode scheme missing - "QuotaGuard" scheme not in dropdown, only "QuotaGuardWidgetExtension"
- **Resolution:** User needs to create new scheme via Manage Schemes > + > Target: QuotaGuard

### Next steps:

- [x] User to create QuotaGuard scheme in Xcode and rebuild to test fix

---

## Session 7: Cursor Usage API Fix (~20 min)

**Status:** Complete

### Problem

Cursor usage showing incorrect data:
- 0 / 500 requests (should show actual usage)
- 0% usage
- "Resets: 1 wk ago" (incorrect reset date)

### Root Cause

The old `/api/usage` endpoint required a `?user=<workosId>` query parameter that wasn't being passed. The response also used `startOfMonth` which was the billing cycle start, not end.

### Solution

Researched [Vibeviewer](https://github.com/MarveleE/Vibeviewer) implementation and adopted their approach:

1. **New API endpoint**: `/api/usage-summary` instead of `/api/usage`
   - Returns proper billing cycle dates
   - Returns plan usage breakdown (used/total)
   - No query parameters required

2. **Browser-like headers**: Added Origin, Referer, User-Agent headers

3. **Proper reset date**: Now uses `billingCycleEnd` (when quota resets)

4. **Plan usage parsing**: Uses `individualUsage.plan.used` and `individualUsage.plan.total`

### Files changed:

- `QuotaGuard/Services/CursorLocalService.swift`
  - Changed endpoint from `/api/usage` to `/api/usage-summary`
  - Added `buildHeaders()` with browser-like headers
  - Replaced `fetchUsage()` with `fetchUsageSummary()`
  - Updated response models: `CursorUsageSummaryResponse`, `CursorIndividualUsage`, `CursorPlanUsage`, `CursorOnDemandUsage`, `CursorTeamUsage`
  - Fixed `fetchUsageMetrics()` to parse new response format
  - Reset date now uses `billingCycleEnd` instead of `startOfMonth`

### API Response Structure (new)

```json
{
  "billingCycleStart": "2026-01-05T...",
  "billingCycleEnd": "2026-02-05T...",
  "membershipType": "pro_plus",
  "individualUsage": {
    "plan": {
      "used": 127,
      "total": 500,
      "included": 500,
      "bonus": 0,
      "remaining": 373
    },
    "onDemand": {
      "enabled": false
    }
  }
}
```

### Decisions:

- **Use /api/usage-summary**: More reliable than /api/usage, doesn't require user ID parameter
- **Show subscription type**: Now displays membershipType (e.g., "Pro+") in UI badge
- **Keep weeklyLimit naming**: Internal model still uses `weeklyLimit` but UI shows "Monthly"

### Result:

- Cursor usage now displays correctly (e.g., "127 / 500")
- Reset date shows future billing cycle end date
- Subscription type badge displays correctly

### Next steps:

- None (feature complete)

---

## Session 8: Widget App Group Debug (~10 min)

**Status:** In Progress

### Problem

Widget showing "No services connected" despite earlier session adding App Group entitlements to plist files.

### Root Cause

App Group entitlements were added to `.entitlements` files but the **App Groups capability was never enabled in Xcode's Signing & Capabilities**. The entitlements plist alone is not enough - Xcode must register the App Group with the Apple Developer account provisioning profile.

Evidence: `~/Library/Group Containers/group.dev.shipshit.quotaguard` directory does not exist.

### What was done:

1. **Diagnosed the issue**: `FileManager.containerURL(forSecurityApplicationGroupIdentifier:)` returns `nil` because the App Group isn't provisioned
2. **Added debug logging** to both SharedDataStore files:
   - `QuotaGuard/Services/SharedDataStore.swift` - logs when App Group container is unavailable
   - `QuotaGuardWidget/UsageWidget.swift` - logs detailed read status (container available, file found, decode success)

### Files changed:

- `QuotaGuard/Services/SharedDataStore.swift` - Added debug logging for App Group availability
- `QuotaGuardWidget/UsageWidget.swift` - Added debug logging for widget data loading

### Fix Required (in Xcode):

1. Select **QuotaGuard** target → **Signing & Capabilities** → **+ Capability** → **App Groups** → Add `group.dev.shipshit.quotaguard`
2. Select **QuotaGuardWidgetExtension** target → same steps
3. Rebuild both targets

### Next steps:

- [ ] User to add App Groups capability in Xcode for both targets
- [ ] Rebuild and verify console shows "✅ [SharedDataStore] Writing to App Group..."
- [ ] Reload widget to verify data displays

---

## Session 9: Claude Code Statusline Configuration (~10 min)

**Status:** Complete

### Goal

Configure Claude Code statusline to match user's terminal PS1 prompt and add token usage display.

### What was done:

1. **Created statusline script** at `~/.claude/statusline-command.sh`
   - Converted zsh PROMPT to bash script
   - Preserved color scheme: gray (243), pink (197), cyan (39)

2. **Added token usage display** to statusline
   - Input tokens (↑) and output tokens (↓) in yellow
   - Context window percentage with color coding:
     - Green: < 60%
     - Orange: 60-80%
     - Red: > 80%
   - Token counts auto-format (k, M suffixes)

3. **Updated settings.json** with statusline command reference

### Files changed:

- `~/.claude/settings.json` - Added statusLine configuration
- `~/.claude/statusline-command.sh` - NEW: Statusline script with token display

### Statusline format:

```
Opus 4.5 /path/to/dir [branch] ↑45.0k ↓12.0k [28%]
```

### Decisions:

- **Removed username@hostname**: Replaced with model name for more useful info
- **Added context percentage**: Visual indicator of when to consider clearing context
- **Color-coded percentage**: Quick visual for context pressure

### Next steps:

- None (feature complete)

---

## Session 10: UI Cleanup (~5 min)

**Status:** Complete

### Goal

Clean up redundant UI elements in MenuBarView.

### What was done:

1. **Removed redundant "25 / 100" display** from LimitRow
   - Now only shows percentage and reset time
   - Removed unused `formatNumber()` function

2. **Removed gear icon from Cursor** when authenticated
   - When hasAccess is true, only the status indicator dot is shown
   - Gear button only appears for Configure when not authenticated

3. **Fixed Pro_Plus → Pro+ display**
   - Added `formatSubscriptionType()` function to CursorServiceRow
   - Converts "Pro_Plus" to "Pro+" for cleaner display

### Files changed:

- `QuotaGuard/Views/MenuBarView.swift`
  - LimitRow: Removed "used / total" HStack, removed `formatNumber()` function
  - CursorServiceRow: Removed gear button when hasAccess is true, added `formatSubscriptionType()`

### Note:

User/linter also made additional changes:
- Removed OpenAI service row from menu bar
- Changed all service rows to use tappable header pattern (entire row toggles expand)
- Added `CompactProgressBar` component for collapsed header state
- Changed default `isExpanded` to `false` for all services

### Next steps:

- None
