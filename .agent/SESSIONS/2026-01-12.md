# Session: 2026-01-12

## Session 4: Widget Shared Data Fix (~30 min)

**Status:** Complete

### System Flow Diagram

1. App refreshes usage in `UsageDataManager.refreshAll()`
   ↓
2. App writes metrics to App Group JSON (`cached_usage_metrics.json`)
   ↓
3. Widget reads the same JSON via App Group container
   ↓
4. Widget timeline renders usage (including Claude Code)

### What was done:

- Added App Group entitlements to app and widget targets
- Created widget entitlements file and wired it in Xcode project settings
- Updated widget shared store to read the same JSON file as the app
- Added Claude Code to widget service types for decoding/display

### Files changed:

- `QuotaGuard/QuotaGuard.entitlements` - added App Group entitlement
- `QuotaGuard/App/QuotaGuard.entitlements` - added App Group entitlement
- `QuotaGuardWidget/QuotaGuardWidget.entitlements` - new widget entitlements file
- `QuotaGuard.xcodeproj/project.pbxproj` - widget CODE_SIGN_ENTITLEMENTS set
- `QuotaGuardWidget/UsageWidget.swift` - shared store + Claude Code service

### Decisions:

- **Decision:** Reuse App Group JSON file for widget data
  - **Context:** App already writes JSON to App Group container
  - **Rationale:** Minimal change and consistent data source

### Mistakes and fixes:

- None

### Next steps:

- [ ] Confirm App Group capability is enabled in Xcode for both targets
- [ ] Rebuild app + widget to validate timeline data updates

---

## Session 3: Usage Collection Review (~20 min)

**Status:** Complete

### What was done:

- Reviewed usage collection for Claude Code, Codex CLI, and Cursor
- Identified display/auth gating issues for Codex and UI mismatch notes
- Drafted recommendations for Codex display parity and Cursor reset/limit fixes

### Files changed:

- None (review only)

### Decisions:

- **Decision:** Provide review findings without code changes
  - **Context:** User requested a review and guidance
  - **Rationale:** Await confirmation before modifying behavior

### Mistakes and fixes:

- None

### Next steps:

- [ ] Add Codex service type/UI row or allow Codex metrics to display without OpenAI admin key
- [ ] Fix Cursor reset time to end-of-month and adjust request limit calculation
- [ ] Update Cursor UI copy to reflect SQLite auth and align rescan behavior in menu

---

## Session 1: QuotaGuard Sandbox & UI Fixes (~45 min)

**Status:** In Progress (pending entitlements verification)

### What was done:

1. **Reordered service cards** in MenuBarView.swift
   - New order: Claude Code, Claude API, OpenAI, Cursor
   - Changed from showing all 4 to auto-detect Claude service (Claude Code if logged in, else Claude API)

2. **Fixed Claude Code expand/collapse**
   - Chevron now properly toggles usage metrics visibility
   - Changed icon from gearshape to chevron.down when collapsed

3. **Created entitlements file** (`QuotaGuard/QuotaGuard.entitlements`)
   - `com.apple.security.network.client` - for API calls
   - `com.apple.security.files.user-selected.read-only`
   - `com.apple.security.temporary-exception.files.home-relative-path.read-only` - for Cursor database access

4. **Fixed ClaudeCodeLocalService API endpoint**
   - Removed multiple endpoint trial-and-error
   - Now uses single working endpoint: `https://api.anthropic.com/api/oauth/usage`
   - Removed verbose logging

5. **Fixed duplicate refresh calls**
   - Removed initial `refreshAll()` in `applicationDidFinishLaunching`
   - `monitorUsage()` already handles initial refresh

6. **Fixed Cursor database path for sandbox**
   - Added `getRealHomeDirectory()` function using `getpwuid(getuid())`
   - Sandbox remaps home directory to container; now uses real home path
   - Database now found at correct path: `/Users/decod3rs/Library/Application Support/Cursor/User/globalStorage/state.vscdb`

### Files changed:

- `QuotaGuard/Views/MenuBarView.swift` - Reordered services, fixed expand/collapse, auto-detect Claude service
- `QuotaGuard/Services/ClaudeCodeLocalService.swift` - Single endpoint, removed verbose logging, simplified fetch
- `QuotaGuard/Services/CursorLocalService.swift` - Added `getRealHomeDirectory()`, better error logging
- `QuotaGuard/Services/UsageDataManager.swift` - Removed verbose logging
- `QuotaGuard/App/QuotaGuardApp.swift` - Removed duplicate refresh call
- `QuotaGuard/QuotaGuard.entitlements` - NEW: Created with network + file access entitlements

### Decisions:

- **Auto-detect Claude service**: Show Claude Code if OAuth available, else show Claude API if key configured, else show Claude Code with login prompt
- **Temporary exception entitlement**: Required for sandbox to read Cursor database at `~/Library/Application Support/Cursor/`

### Pending/Next steps:

- [ ] Verify entitlements file is linked in Xcode Build Settings (`CODE_SIGN_ENTITLEMENTS = QuotaGuard/QuotaGuard.entitlements`)
- [ ] Rebuild and test Cursor database access with proper entitlements
- [ ] Test full functionality: Claude Code usage, Cursor usage display

### Known issues:

- Cursor database found but "not readable" - sandbox still blocking despite entitlements file created
- Need to set `Code Signing Entitlements` in Build Settings to `QuotaGuard/QuotaGuard.entitlements`

---

## Session 2: Code Simplification & Optimization (~20 min)

**Status:** Complete

### Goal

Analyze codebase for optimization opportunities and remove duplicate code.

### What was done:

1. **Deleted dead code** - Removed unused `CursorService.swift` (32 lines)
   - File was never imported or referenced
   - Only contained Twitter intent stub and error-throwing fetch method
   - `CursorLocalService` is the actual implementation used

2. **Added `UsageStatus.color` extension** - Eliminated 9 duplicate functions
   - Added `color` property to `UsageStatus` enum in `UsageLimit.swift`
   - Added same property to widget's local `UsageStatus` in `UsageWidget.swift`
   - Removed 5 `colorForStatus()` functions from `MenuBarView.swift`
   - Removed 4 `colorForStatus()` functions from `UsageWidget.swift`

3. **Fixed duplicate refresh loop** in `QuotaGuardApp.swift`
   - **Before:** `monitorUsage()` called `refreshAll()` every 5 min + `UsageDataManager` timer every 15 min
   - **After:** Single initial refresh on launch, `UsageDataManager` handles 15-min auto-refresh
   - Notification check still runs every 5 min but doesn't trigger API calls

### Files changed:

- `QuotaGuard/Services/CursorService.swift` - DELETED (dead code)
- `QuotaGuard/Models/UsageLimit.swift` - Added `UsageStatus.color` property, added SwiftUI import
- `QuotaGuard/Views/MenuBarView.swift` - Removed 5 duplicate `colorForStatus()` functions, updated to use `.color`
- `QuotaGuardWidget/UsageWidget.swift` - Added `UsageStatus.color`, removed 4 duplicate functions
- `QuotaGuard/App/QuotaGuardApp.swift` - Removed redundant `refreshAll()` from monitoring loop

### Code impact:

| Metric | Before | After |
|--------|--------|-------|
| `colorForStatus()` functions | 9 | 0 |
| Duplicate refresh calls | 2 (5min + 15min) | 1 (15min) |
| Dead code files | 1 | 0 |
| Lines removed | ~86 | - |

### Decisions:

- **Skipped URLSession extraction** - Only 6 lines duplicated, abstraction overhead not worth it
- **Skipped ServiceRow consolidation** - Larger refactor requiring careful planning, deferred to future session

### Not completed (future work):

- [ ] Consolidate 3 ServiceRow views (ServiceRowView, CursorServiceRow, ClaudeCodeServiceRow) - share 80% code
- [ ] Share models between main app and widget target (currently duplicated)
- [ ] Extract magic number thresholds (80%, 90%, 100%) to constants

---

## Session 3: README Screenshots (~20 min)

**Status:** Complete

### What was done:

1. **Built a SwiftUI snapshot renderer** to generate static screenshots for README use.
2. **Generated toolbar and widget images** with realistic sample usage data.
3. **Improved rendering fidelity** by replacing SwiftUI progress bars with a custom progress view to avoid missing render artifacts.

### Files changed:

- `scripts/render-readme-screenshots.swift` - New snapshot renderer script
- `docs/screenshots/menubar.png` - Menu bar UI screenshot (2x)
- `docs/screenshots/widget-medium.png` - Medium widget UI screenshot (2x)

### Notes:

- Renderer is run via `swiftc -parse-as-library` to avoid `@main` conflicts in Swift script mode.
- Uses local `.build/tmp` and `.build/module-cache` paths to avoid sandboxed cache permissions.

### Next steps:

- [ ] Add the new screenshots to `README.md` if desired
